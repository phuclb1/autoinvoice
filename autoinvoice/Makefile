# AutoInvoice - Build Makefile
# Build Tauri desktop app for macOS and Windows

.PHONY: help install dev build build-macos build-windows clean lint format check

# Default target
help:
	@echo "AutoInvoice Build Commands"
	@echo "=========================="
	@echo ""
	@echo "Development:"
	@echo "  make install     - Install dependencies (npm + cargo)"
	@echo "  make dev         - Run development server"
	@echo "  make check       - Check code (lint + type check + cargo check)"
	@echo "  make lint        - Run ESLint"
	@echo "  make format      - Format code with Prettier"
	@echo ""
	@echo "Build:"
	@echo "  make build       - Build for current platform"
	@echo "  make build-macos - Build for macOS (universal binary)"
	@echo "  make build-windows - Build for Windows (via GitHub Actions)"
	@echo ""
	@echo "Utility:"
	@echo "  make clean       - Clean build artifacts"
	@echo ""

# Install all dependencies
install:
	@echo "ðŸ“¦ Installing npm dependencies..."
	npm install
	@echo "ðŸ¦€ Checking Rust toolchain..."
	rustup update stable
	@echo "âœ… Dependencies installed"

# Run development server
dev:
	@echo "ðŸš€ Starting development server..."
	npm run tauri dev

# Build for current platform
build:
	@echo "ðŸ”¨ Building for current platform..."
	npm run tauri build
	@echo "âœ… Build complete! Check src-tauri/target/release/bundle/"

# Build for macOS (universal binary - Intel + Apple Silicon)
build-macos:
	@echo "ðŸŽ Building for macOS..."
	@echo "Adding macOS targets..."
	rustup target add x86_64-apple-darwin aarch64-apple-darwin 2>/dev/null || true
	@echo "Building universal binary..."
	npm run tauri build -- --target universal-apple-darwin
	@echo "âœ… macOS build complete!"
	@echo "ðŸ“ Output: src-tauri/target/universal-apple-darwin/release/bundle/"
	@ls -la src-tauri/target/universal-apple-darwin/release/bundle/dmg/ 2>/dev/null || true
	@ls -la src-tauri/target/universal-apple-darwin/release/bundle/macos/ 2>/dev/null || true

# Build for macOS Intel only
build-macos-intel:
	@echo "ðŸŽ Building for macOS (Intel x64)..."
	rustup target add x86_64-apple-darwin 2>/dev/null || true
	npm run tauri build -- --target x86_64-apple-darwin
	@echo "âœ… macOS Intel build complete!"
	@echo "ðŸ“ Output: src-tauri/target/x86_64-apple-darwin/release/bundle/"

# Build for macOS Apple Silicon only
build-macos-arm:
	@echo "ðŸŽ Building for macOS (Apple Silicon)..."
	rustup target add aarch64-apple-darwin 2>/dev/null || true
	npm run tauri build -- --target aarch64-apple-darwin
	@echo "âœ… macOS ARM build complete!"
	@echo "ðŸ“ Output: src-tauri/target/aarch64-apple-darwin/release/bundle/"

# Build for Windows
# Note: Windows builds require GitHub Actions CI (cannot cross-compile from macOS)
build-windows:
	@echo "ðŸªŸ Windows Build"
	@echo "================"
	@echo "Windows builds are done via GitHub Actions CI."
	@echo ""
	@echo "To build for Windows:"
	@echo "  1. Push to main branch or create a tag (v*)"
	@echo "  2. GitHub Actions will build automatically"
	@echo "  3. Download artifacts from the workflow run"
	@echo ""
	@echo "Or trigger manually:"
	@echo "  gh workflow run build.yml"
	@echo ""
	@exit 1

# Run all checks
check: lint
	@echo "ðŸ” Running TypeScript check..."
	npx tsc --noEmit
	@echo "ðŸ¦€ Running Cargo check..."
	cd src-tauri && cargo check
	@echo "âœ… All checks passed"

# Run ESLint
lint:
	@echo "ðŸ” Running ESLint..."
	npm run lint

# Fix ESLint issues
lint-fix:
	@echo "ðŸ”§ Fixing ESLint issues..."
	npm run lint:fix

# Format code
format:
	@echo "ðŸ’… Formatting code..."
	npm run format
	cd src-tauri && cargo fmt
	@echo "âœ… Code formatted"

# Check formatting
format-check:
	@echo "ðŸ” Checking code formatting..."
	npm run format:check
	cd src-tauri && cargo fmt --check

# Clean build artifacts
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -rf dist
	rm -rf src-tauri/target
	rm -rf node_modules/.vite
	@echo "âœ… Clean complete"

# Clean and rebuild
rebuild: clean install build
	@echo "âœ… Rebuild complete"

# Build all platforms
# Note: Windows builds are handled by GitHub Actions CI
build-all: build-macos
	@echo "âœ… macOS build complete!"
	@echo ""
	@echo "Build outputs:"
	@echo "  macOS: src-tauri/target/universal-apple-darwin/release/bundle/"
	@echo ""
	@echo "For Windows builds, use GitHub Actions:"
	@echo "  gh workflow run build.yml"

# Release build with optimizations
release:
	@echo "ðŸš€ Building release version..."
	CARGO_PROFILE_RELEASE_LTO=true npm run tauri build
	@echo "âœ… Release build complete"

# Show build info
info:
	@echo "Build Information"
	@echo "================"
	@echo "Node version: $$(node --version)"
	@echo "npm version: $$(npm --version)"
	@echo "Rust version: $$(rustc --version)"
	@echo "Cargo version: $$(cargo --version)"
	@echo "Tauri CLI version: $$(npm run tauri -- --version 2>/dev/null | tail -1)"
	@echo ""
	@echo "Installed targets:"
	@rustup target list --installed
